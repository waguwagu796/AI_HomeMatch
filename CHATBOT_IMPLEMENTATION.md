# Home'Scan AI 챗봇 구현 가이드

## 📋 목차
1. [개요](#개요)
2. [사용 모델 및 기술 스택](#사용-모델-및-기술-스택)
3. [구현 방식](#구현-방식)
4. [답변 생성 프로세스](#답변-생성-프로세스)
5. [가이드 데이터 구조](#가이드-데이터-구조)
6. [제약사항 및 한계](#제약사항-및-한계)
7. [참고 자료](#참고-자료)

---

## 개요

Home'Scan AI 챗봇은 **부동산 임대차 관리**에 특화된 상담 어시스턴트입니다. 계약서 점검, 등기부등본 분석, 거주 관리, 퇴실 관리 등 4가지 주제에 대해 사용자의 질문에 답변합니다.

### 핵심 특징
- **학습 없음**: 사전 학습된 LLM을 사용하며, 별도의 파인튜닝이나 학습 과정 없음
- **가이드 기반 답변**: 사전 정의된 JSON 가이드 데이터만을 참고하여 답변 생성
- **하이브리드 방식**: 가이드 매칭 성공 시 즉답, 실패 시 LLM 호출
- **법률 자문 아님**: 참고 정보 제공에 그치며, 법률적 조언을 대체하지 않음

---

## 사용 모델 및 기술 스택

### LLM 모델
- **모델명**: `gpt-4o-mini` (OpenAI API)
- **제공자**: OpenAI
- **API 엔드포인트**: `https://api.openai.com/v1/chat/completions`
- **모델 선택 이유**: 
  - 비용 효율적 (GPT-4 대비 저렴)
  - 충분한 성능 (간단한 상담 답변에 적합)
  - 빠른 응답 속도

### 기술 스택
- **Backend**: Spring Boot 3.2.1 (Java 17)
- **HTTP Client**: Spring WebFlux (Reactive)
- **데이터베이스**: MariaDB (대화 히스토리 저장)
- **인증**: JWT (Bearer Token)
- **가이드 데이터**: JSON 파일 (`chatbot-guides.json`)

---

## 구현 방식

### 1. 하이브리드 답변 생성 전략

챗봇은 **2단계 답변 생성 전략**을 사용합니다:

```
사용자 질문
    ↓
[1단계] 가이드 데이터 매칭 시도
    ├─ 성공 → JSON에서 직접 포맷팅하여 즉답 반환 (LLM 호출 없음)
    └─ 실패 → [2단계] LLM 호출
```

#### 1단계: 가이드 기반 즉답 (Guide-based Direct Answer)

**동작 방식**:
- 사용자가 **추천 질문**을 클릭한 경우, 해당 질문의 `section` 경로를 통해 가이드 JSON의 특정 블록을 찾음
- JSON 블록을 읽기 쉬운 문장으로 포맷팅하여 즉시 반환
- **LLM 호출 없음** → 빠른 응답, 비용 절감

**예시**:
```
사용자 질문: "보증금은 언제 받을 수 있나요?"
→ suggested_questions.moveout에서 매칭
→ section: "moveout_management.deposit_management"
→ JSON에서 해당 블록 추출 및 포맷팅
→ 즉답 반환
```

#### 2단계: LLM 기반 답변 (LLM-based Response)

**동작 방식**:
- 가이드 매칭 실패 시, OpenAI API 호출
- 시스템 프롬프트에 가이드 데이터 전체(또는 주제별 섹션)를 컨텍스트로 제공
- 대화 히스토리(최근 10개)를 함께 전달하여 맥락 유지
- LLM이 가이드 데이터를 참고하여 답변 생성

### 2. 시스템 프롬프트 설계

시스템 프롬프트는 다음 원칙을 따릅니다:

#### 말투 및 형식
- **자연스러운 상담사 톤**: "~해 드릴게요", "궁금하신 점" 같은 AI스러운 말투 지양
- **간결함**: 짧고 명확한 답변
- **마크다운 금지**: `###`, `**`, `*` 등 마크다운 형식 사용 안 함
- **참고 안내 톤**: 정답 제시가 아닌 "참고하면 좋다"는 식으로 안내

#### 내용 규칙
- **가이드 데이터만 참고**: 가이드에 없는 내용은 추측하지 않음
- **법률 자문 아님 명시**: 필요 시 "(가이드 기준 참고용이에요, 법률 자문이 아님)" 안내
- **법·금액·기간 등**: 가이드에 적힌 것만 인용

#### 프롬프트 예시
```
당신은 Home'Scan 앱 이용자를 돕는 상담사입니다. 아래 [가이드 정보]만을 참고해서 답하세요.

말투·형식:
- 진짜 사람 상담사처럼 짧고 명확하게 말하세요. GPT/AI스러운 말투는 쓰지 마세요.
- 절대 정답을 주는 게 아니라 '참고하면 좋다'는 식으로만 안내하세요.
- 답변에 ###, **, *, #, 불릿 리스트용 마크다운을 사용하지 마세요.

내용 규칙:
- 답변의 근거는 오직 아래 가이드 정보뿐입니다.
- 가이드에 있는 내용만 간단히 풀어서 알려 주세요.
- 필요하면 한 줄만 "(가이드 기준 참고용이에요, 법률 자문이 아님)"처럼 붙여도 됩니다.

가이드 정보 (이 내용만 사용할 것):
[가이드 JSON 데이터]
```

### 3. LLM 호출 파라미터

```java
{
  "model": "gpt-4o-mini",
  "messages": [...],
  "temperature": 0.3,      // 낮은 값 → 일관성 있는 답변
  "max_tokens": 1000       // 최대 토큰 수 제한
}
```

**파라미터 선택 이유**:
- `temperature: 0.3`: 창의성보다 정확성 중시 (가이드 기반 답변)
- `max_tokens: 1000`: 적절한 길이의 답변 유도

---

## 답변 생성 프로세스

### 전체 플로우

```
1. 사용자 질문 수신
   ↓
2. JWT 토큰 검증 및 사용자 식별
   ↓
3. 대화 세션 조회/생성 (사용자당 최신 세션 사용)
   ↓
4. 사용자 메시지 DB 저장
   ↓
5. 대화 히스토리 조회 (최근 10개)
   ↓
6. [가이드 매칭 시도]
   ├─ 추천 질문과 정확히 일치?
   │   ├─ YES → JSON 블록 포맷팅 → 즉답 반환 (종료)
   │   └─ NO → 다음 단계
   ↓
7. [LLM 호출]
   ├─ 주제별 가이드 컨텍스트 준비
   ├─ 시스템 프롬프트 + 가이드 + 대화 히스토리 + 사용자 메시지
   ├─ OpenAI API 호출
   ├─ 응답 파싱 및 마크다운 제거
   └─ 답변 반환
   ↓
8. 봇 메시지 DB 저장
   ↓
9. 응답 반환
```

### 주제별 가이드 필터링

사용자가 주제를 선택한 경우, 해당 주제의 가이드만 컨텍스트로 제공:

| 주제 (topic) | 가이드 섹션 |
|------------|-----------|
| `contract_review` | `contract_guide` |
| `deed_analysis` | `contract_guide` |
| `residency` | `residency_management` |
| `moveout` | `moveout_management` |

주제가 없으면 전체 가이드 데이터를 컨텍스트로 사용.

### Fallback 메커니즘

LLM 호출 실패 시:
1. **API 키 미설정**: "OpenAI API 키가 설정되지 않았습니다" 메시지 반환
2. **API 호출 실패**: 키워드 기반 간단한 답변 생성 (`generateBotResponse` 메서드)
   - "거주", "입주", "주거비" → 거주 관리 안내
   - "퇴실", "보증금", "원상복구" → 퇴실 관리 안내
   - "계약서" → 계약서 점검 안내
   - 기타 → 일반 안내

---

## 가이드 데이터 구조

### 파일 위치
`backend/src/main/resources/chatbot-guides.json`

### 구조 개요

```json
{
  "residency_management": { ... },      // 거주 관리
  "moveout_management": { ... },        // 퇴실 관리
  "contract_guide": { ... },           // 계약서/등기부등본
  "property_guide": { ... },           // 매물 찾기
  "suggested_questions": {              // 추천 질문
    "residency": [...],
    "moveout": [...],
    "contract_review": [...],
    "deed_analysis": [...]
  }
}
```

### 추천 질문 구조

각 주제별 추천 질문은 `label`과 `section`으로 구성:

```json
{
  "label": "보증금은 언제 받을 수 있나요?",
  "section": "moveout_management.deposit_management"
}
```

- `label`: 사용자에게 보여지는 질문 텍스트
- `section`: 가이드 JSON에서 해당 답변을 찾을 경로 (점으로 구분)

### 가이드 섹션 예시

```json
{
  "deposit_management": {
    "title": "보증금 관리",
    "return_obligation": {
      "description": "임대인은 임차인이 퇴실하고 주택을 인도받은 뒤 보증금을 반환해야 할 의무가 있습니다",
      "reasonable_period": "통상적으로는 퇴실 후 1개월 이내가 합리적인 반환 기간으로 판단됩니다",
      "note": "관리비 정산, 시설 점검 등 합리적인 기간은 인정될 수 있습니다"
    }
  }
}
```

이 JSON 블록은 다음과 같이 포맷팅되어 사용자에게 전달됩니다:

```
보증금 관리

임대인은 임차인이 퇴실하고 주택을 인도받은 뒤 보증금을 반환해야 할 의무가 있습니다

합리적인 반환 기간: 통상적으로는 퇴실 후 1개월 이내가 합리적인 반환 기간으로 판단됩니다

참고: 관리비 정산, 시설 점검 등 합리적인 기간은 인정될 수 있습니다
```

---

## 제약사항 및 한계

### 1. 가이드 데이터 의존성

- **가이드에 없는 내용은 답변 불가**: 가이드 데이터에 없는 주제나 질문에 대해서는 "가이드에 없어서 ○○ 페이지에서 확인해 주세요" 정도로만 안내
- **법률 자문 아님**: 가이드 데이터는 일반적인 참고 정보이며, 법률적 조언을 대체하지 않음

### 2. LLM 제약사항

- **API 키 필요**: `.env` 파일에 `OPENAI_API_KEY` 설정 필요
- **비용 발생**: OpenAI API 호출 시 토큰 사용량에 따라 비용 발생
- **응답 지연**: 네트워크 상태에 따라 응답 시간 변동 가능
- **토큰 제한**: `max_tokens: 1000`으로 제한되어 긴 답변 생성 어려움

### 3. 대화 히스토리 제한

- **최근 10개만 사용**: 대화 히스토리가 길어지면 오래된 맥락 손실 가능
- **세션 기반**: 사용자당 최신 세션만 사용 (이전 세션 히스토리 참조 안 함)

### 4. 답변 품질

- **가이드 데이터 품질에 의존**: 가이드 데이터가 부정확하거나 불완전하면 답변 품질 저하
- **LLM 할루시네이션 가능성**: 가이드에 없는 내용을 추측하여 답변할 수 있음 (시스템 프롬프트로 최소화 시도)

### 5. 언어 제한

- **한국어 전용**: 현재 한국어 질문/답변만 지원
- **다국어 지원 없음**: 영어 등 다른 언어 질문에 대한 지원 없음

---

## 참고 자료

### 코드 파일

1. **ChatbotService.java**
   - 위치: `backend/src/main/java/com/homematch/domain/chatbot/ChatbotService.java`
   - 역할: 챗봇 비즈니스 로직, 가이드 매칭, LLM 호출 오케스트레이션

2. **OpenAIService.java**
   - 위치: `backend/src/main/java/com/homematch/domain/chatbot/OpenAIService.java`
   - 역할: OpenAI API 호출, 시스템 프롬프트 구성, 응답 파싱

3. **ChatbotController.java**
   - 위치: `backend/src/main/java/com/homematch/domain/chatbot/ChatbotController.java`
   - 역할: REST API 엔드포인트, 인증 처리

4. **chatbot-guides.json**
   - 위치: `backend/src/main/resources/chatbot-guides.json`
   - 역할: 가이드 데이터 (답변의 근거)

### API 엔드포인트

#### 1. 추천 질문 목록 조회
```
GET /api/chatbot/suggested-questions?topic={topic}
```
- **인증**: 불필요
- **파라미터**: `topic` (선택) - `residency`, `moveout`, `contract_review`, `deed_analysis`
- **응답**: 추천 질문 목록 (JSON 배열)

#### 2. 메시지 전송
```
POST /api/chatbot/messages
Headers: Authorization: Bearer {JWT_TOKEN}
Body: {
  "text": "사용자 질문",
  "topic": "residency" (선택)
}
```
- **인증**: 필요 (JWT Bearer Token)
- **응답**: 봇 답변 (ChatbotMessageResponse)

#### 3. 메시지 히스토리 조회
```
GET /api/chatbot/messages
Headers: Authorization: Bearer {JWT_TOKEN}
```
- **인증**: 필요
- **응답**: 대화 히스토리 목록 (최신순)

#### 4. 메시지 히스토리 삭제
```
DELETE /api/chatbot/messages
Headers: Authorization: Bearer {JWT_TOKEN}
```
- **인증**: 필요
- **응답**: 204 No Content

### 데이터베이스 스키마

#### ChatSession (대화 세션)
- `sessionId`: 세션 ID (PK)
- `user`: 사용자 (FK)
- `createdAt`: 생성 시각

#### ChatMessage (대화 메시지)
- `messageId`: 메시지 ID (PK)
- `session`: 세션 (FK)
- `role`: 역할 (`user` 또는 `assistant`)
- `content`: 메시지 내용
- `createdAt`: 생성 시각

### 환경 변수 설정

`.env` 파일에 다음 변수 설정 필요:

```env
OPENAI_API_KEY=sk-...
DB_URL=jdbc:mariadb://...
DB_USER=...
DB_PASSWORD=...
```

---

## 개선 가능한 방향

### 1. 벡터 검색 (RAG) 도입
- 현재는 전체 가이드 데이터를 컨텍스트로 제공
- 벡터 DB를 사용하여 질문과 관련된 가이드 섹션만 검색하여 컨텍스트 축소 가능
- 비용 절감 및 응답 품질 향상

### 2. 대화 히스토리 개선
- 현재는 최근 10개만 사용
- 중요 맥락을 요약하여 더 긴 히스토리 유지 가능

### 3. 다국어 지원
- 영어 등 다른 언어 질문에 대한 지원 추가

### 4. 답변 검증
- LLM 답변이 가이드 데이터를 벗어나지 않았는지 검증 로직 추가
- 가이드 외 내용 포함 시 경고 또는 재생성

### 5. 사용자 피드백 수집
- 답변 만족도 조사 기능 추가
- 피드백 기반 가이드 데이터 개선

---

## 요약

Home'Scan AI 챗봇은 **학습 없이** 사전 정의된 가이드 데이터를 기반으로 답변을 생성합니다. GPT-4o-mini 모델을 사용하지만, 가이드 데이터에 없는 내용은 답변하지 않도록 제한되어 있습니다. 하이브리드 방식(가이드 매칭 → 즉답 / 실패 시 LLM 호출)으로 빠른 응답과 비용 효율성을 동시에 추구하며, 법률 자문이 아닌 참고 정보 제공에 그치는 것을 명확히 합니다.
